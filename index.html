<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sheet Viewer</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body { font-family: Arial; margin: 20px; }

.table-container {
    overflow: auto;
    max-height: 80vh;
    border: 1px solid #ccc;
}

table {
    border-collapse: collapse;
    width: max-content;
}

th, td {
    border: 1px solid #ccc;
    padding: 4px 8px;
    white-space: nowrap;
}
</style>
</head>

<body>

<h2>Sheet Viewer</h2>
<div style="margin-bottom:15px;">
    <button onclick="switchTab('Cat1')">Cat1</button>
    <button onclick="switchTab('Cat2')">Cat2</button>
    <button onclick="switchTab('Cat3')">Cat3</button>
</div>
<div id="tableArea"></div>

<script>

const sheets = {
    Cat1: {
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeBugtsvSMiAlwoZwg_QVXDFN0lMvKAj0bLHLEeyk8KCihgezOPw-1Mh0m7I-48fJvRpKWi9UGwXyc/pub?gid=1706593238&single=true&output=csv",
        frozenRows: 2,
        hiddenCols: ["AA"]
    },
    Cat2: {
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeBugtsvSMiAlwoZwg_QVXDFN0lMvKAj0bLHLEeyk8KCihgezOPw-1Mh0m7I-48fJvRpKWi9UGwXyc/pub?gid=1880374698&single=true&output=csv",
        frozenRows: 2,
        hiddenCols: ["A","AA"]
    },
    Cat3: {
        url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeBugtsvSMiAlwoZwg_QVXDFN0lMvKAj0bLHLEeyk8KCihgezOPw-1Mh0m7I-48fJvRpKWi9UGwXyc/pub?gid=482846150&single=true&output=csv",
        frozenRows: 2,
        hiddenCols: ["A","B","C","D","E","F","G","H","I","AA"]
    }
};

let fullData = [];
let configGlobal;
let hiddenIndexes = [];

function colLetterToIndex(letter) {
    let result = 0;
    for (let i = 0; i < letter.length; i++) {
        result *= 26;
        result += letter.charCodeAt(i) - 64;
    }
    return result - 1;
}

function showTab(tab) {
    configGlobal = sheets[tab];
    hiddenIndexes = configGlobal.hiddenCols.map(c => colLetterToIndex(c));

    Papa.parse(configGlobal.url, {
        download: true,
        complete: function(results) {
            fullData = results.data;
            renderTable();
        }
    });
}

function renderTable() {
    const container = document.getElementById("tableArea");
    container.innerHTML = "";

    const table = document.createElement("table");
    const thead = document.createElement("thead");

    for (let r = 0; r < configGlobal.frozenRows; r++) {
        const tr = document.createElement("tr");
        fullData[r].forEach((cell, i) => {
            if (hiddenIndexes.includes(i)) return;
            const th = document.createElement("th");
            th.textContent = cell;
            tr.appendChild(th);
        });
        thead.appendChild(tr);
    }

    const filterRow = document.createElement("tr");
    fullData[0].forEach((_, i) => {
        if (hiddenIndexes.includes(i)) return;
        const th = document.createElement("th");
        const input = document.createElement("input");
        input.dataset.col = i;
        input.oninput = applyFilters;
        th.appendChild(input);
        filterRow.appendChild(th);
    });

    thead.appendChild(filterRow);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    table.appendChild(tbody);

    container.appendChild(table);
    applyFilters();
}

function applyFilters() {

    const inputs = document.querySelectorAll("thead input");
    const tbody = document.querySelector("tbody");
    tbody.innerHTML = "";

    const W = colLetterToIndex("W");
    const X = colLetterToIndex("X");
    const Z = colLetterToIndex("Z");
    const AA = colLetterToIndex("AA");

    let visibleRows = [];
    let counter = 0;

    for (let r = configGlobal.frozenRows; r < fullData.length; r++) {

        let row = [...fullData[r]];
        let show = true;

        inputs.forEach(input => {
            const colIndex = input.dataset.col;
            if (!input.value) return;
            if (!row[colIndex] || !row[colIndex].toLowerCase().includes(input.value.toLowerCase())) {
                show = false;
            }
        });

        if (show) {
            counter++;
            row[AA] = counter;
            visibleRows.push(row);
        }
    }

    // ---- EXACT TIE LOGIC ----
    visibleRows.forEach((row, idx) => {

        const rank = row[AA];

        if (!rank) {
            row[Z] = "";
            return;
        }

        const prev = visibleRows.find(r => r[AA] == rank - 1);
        const next = visibleRows.find(r => r[AA] == rank + 1);

        if (prev && row[W] === prev[W] && row[X] === prev[X]) {
            row[Z] = prev[Z];
            return;
        }

        if (next && row[W] === next[W] && row[X] === next[X]) {

            const sameGroup = visibleRows.filter(r => 
                r[W] === row[W] && r[X] === row[X]
            );

            const maxRank = Math.max(...sameGroup.map(r => r[AA]));
            row[Z] = rank + "-" + maxRank;
            return;
        }

        row[Z] = rank;
    });

    // ---- RENDER ----
    visibleRows.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach((cell, i) => {
            if (hiddenIndexes.includes(i)) return;
            const td = document.createElement("td");
            td.textContent = cell;
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });

    setTimeout(autoSizeColumns, 0);
}

function autoSizeColumns() {

    const table = document.querySelector("table");
    if (!table) return;

    const rows = table.querySelectorAll("tr");
    if (rows.length === 0) return;

    const colCount = rows[0].children.length;

    for (let col = 0; col < colCount; col++) {

        let maxWidth = 0;

        rows.forEach(row => {
            const cell = row.children[col];
            if (!cell) return;
            maxWidth = Math.max(maxWidth, cell.scrollWidth);
        });

        rows.forEach(row => {
            if (row.children[col]) {
                row.children[col].style.width = (maxWidth + 16) + "px";
            }
        });
    }
}

function switchTab(tabName) {
    showTab(tabName);
}
    
showTab("Cat1");

</script>

</body>
</html>
